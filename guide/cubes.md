# Кубы

## Что такое куб

Куб - это набор классов и файлов, объединенные одним пространством имен и имеющие единую ответственность в рамках
определенной кубом функциональности.

Куб - это функциональный пакет (можно к ним относиться как к модулям, компонентам или плагинам) системы.<br>

Кубом может быть как ограниченный функционал какой-либо сущности, например, News, Catalog, Order,
так и глобальный модуль Admin, Api, Public, либо сквозной функционал, такой как Log, Cache и др.

Структура куба может быть такой (минимально):
```
article/
    Cube.php
```

А может быть такой:
```
article/
    admin/
    assets/
    commands/
    classes/
    ...
    Cube.php
    Article.php
    ArticleService.php
    ...
```

То есть нет никаких технических ограничений и всё зависит от того, как разработчик желает организовать свой код.

## Cube.php

Опознавательным признаком куба является класс Cube (файл Cube.php), наследуемый от AbstractCube.

Класс Cube отвечает за:
1. регистрацию зависимостей куба (метод registerDependencies)
2. инициализацию куба, если требуется (метод bootstrap)
3. получение миграций куба, если требуется (метод getMigrations)

Куб может быть временно выключен с помощью свойства:
```php
$enabled = false.
```

## Регистрация кубов

Кубы регистрируются в системе с помощью менеджера кубов CubeManager.
Метод registerAll принимает в качестве аргумента директрию и производит по ней
рекурсивный поиск кубов.

Платформа WCP производит регистрацию кубов с помощью CubeManager самостоятельно,
на основании конфигурации cubesLocation (файл config/config.php).

## Регистрация зависимостей куба (registerDependencies)

В метод registerDependencies по ссылке передается глобальный массив зависимостей.
Куб дописывает в этот массив необходимые для него зависимости в нотации PHP-DI.

```php
    public function registerDependencies(array &$definitions)
    {
        $definitions[ArticleRepositoryInterface::class] = \DI\autowire(ArticleRepositoryMicro::class);
    }
```

## Инициализация куба (bootstrap)

В метод bootstrap передается контейнер зависимостей приложения.
С помощью данного контейнера, куб может "внедриться" в систему.
Через контейнер можно получить и переопределить практически любую часть приложения.

```php
    public function bootstrap(ContainerInterface $container)
    {
        // TODO something
    }
```

## Миграции куба (getMigrations)

При наличии миграций, куб возвращает массив классов-миграций,
которые будут отсортированы по ключу и выполнены командой migrate:up / migrate:down

```php
    public function getMigrations(): array
    {
        return [
            '001_001' => ArticleMigration::class
        ];
    }
```

## Тестирование куба

Хорошим способом организации тестов будет их расположение в самом кубе, к которому они относятся, в директории tests.
Phpunit платформы по умолчанию настроен на рекурсивный поиск тестов по директориям проекта: **/cubes, /modules, /tests**.

Наследовать тесты необходимо от **\AppTestCase**.

## Системные кубы

В директории **cubes/system** находятся системные кубы, от которых зависит функциональность платформы. Это значит, что
удалять или отключать эти кубы нельзя. Все прочие кубы (не нужные для текущего проекта) можно удалить.

Далее: [Сущности (Entity)](entity.md)<br>
Вверх: [Оглавление](index.md)
